//*****************************************************************************
//*****************************************************************************
//*                                                                           *
//*  X86 - CSM (Compatiable Support Module)                                   *
//*                                                                           *
//*****************************************************************************
//*****************************************************************************
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "typedef.h"
#include "csm.h"

//=============================================================================
//  variable
//=============================================================================
csm_t	csm;

//=============================================================================
//  csm_init
//=============================================================================
int csm_init(void)
{
	#ifdef __BORLANDC__
	char far	*addr = (char far *)0xF0000000;	// F000:0000 = 0x000F0000
	#endif
	
	#ifdef __WATCOMC__
	char		*addr = (char *)0xF0000;	// F000:0000 = 0x000F0000;
	#endif
	
	uint32_t	tag;
	uint32_t	off;
	int			found;

	memset(&csm, 0, sizeof(csm_t));
	found = -1;

	// 4-byte alignment
	for (off=0; off<65536; off+=4)
	{
		tag = *(uint32_t *)(addr + off);
		if (tag == 0x24454649)	// $EFI
		{
			found = 0;
			memcpy(&csm.info, (addr + off), sizeof(csm_info_t));
			csm.sts = 1;
			break;
		}
	}

	return found;
}

//=============================================================================
//  csm_get
//=============================================================================
csm_t *csm_get(void)
{
	return &csm;
}
